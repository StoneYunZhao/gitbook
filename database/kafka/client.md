# Client

### 发送消息 Batch 机制

客户端在发送消息给 kafka 服务端时，当有多个消息需要被发送到同一个分区时，生产者会把它们放在同一个批次里，一次通过网络把 Batch 发送过去。提升了吞吐量。

* batch.size：批次的大小。
* linger.ms：发送批次之前等待时间，若达到时间，批次就算没满，也会发送。

**问题**：若没做特殊处理，这些一个个 Batch 数据发送给服务端后，就需要 GC 来回收，这样就会带来较多的 Stop the world 时间，降低性能。

解决方案：**客户端缓冲池机制**。

客户端在开始时就申请一段内存，把这段内存划分成多块，每当需要创建一个 Batch 时就找缓冲池哪一块，Batch 用完后还回给缓冲池就行。所以这样就**避免了频繁的申请内存与 JVM GC**。

当缓冲池满了，无法申请 Batch 时，写入操作就会被阻塞，直到有空闲内存。

* [https://juejin.im/post/5cceec5c51882541914ade42](https://juejin.im/post/5cceec5c51882541914ade42)

