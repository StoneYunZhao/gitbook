# Transport Layer

在 IP 的头里面包含了 8 位协议类型，即 IP 包里面的数据是 UDP 还是 TCP。

## UDP

**用户数据报协议**（**U**ser **D**atagram **P**rotocol，**UDP**，又称**用户数据包协议**）是一个简单的面向数据报的传输层协议。

![](../../.gitbook/assets/image%20%2850%29.png)

特点：

* 通讯简单，它相信网络是美好的，很容易送达数据，不会丢失。
* 信任，建立监听后，都可以给它传数据，也可以给任何人传数据，甚至同时。
* 不能控制拥塞，不管网络堵不堵，都照常发。

适用场景：

* 需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用。如 [DHCP](application-layer.md#dhcp)、[PXE](application-layer.md#pxe)。
* 不需要一对一沟通，建立连接，而是可以广播的应用。DHCP 是一种广播形式。VXLAN 会用到组播（IP [5 类地址](network-layer.md#wu-lei-ip)中的 D 类），也是基于 UDP。
* 需要处理速度快，时延低，可以容忍少数丢包，但是要求即便网络拥塞，也不停止。

### 使用 UDP 的例子

* **QUIC**（**Quick UDP Internet Connections**，**快速 UDP 互联网连接**）是 Google 提出的一种基于 UDP 改进的通信协议，其目的是降低网络通信的延迟，提供更好的用户互动体验。
* **流媒体**：直播多使用 RTMP，是基于 TCP 的，但是容易卡。很多直播应用都基于 UDP 实现了自己的视频传输协议。
* **实时游戏**：游戏对实时要求较为严格，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。
* **IoT 物联网**：物联网终端可能是内存很小的嵌入式系统，维护 TCP 代价较大；另外物联网对实时性要求也很高。Google 旗下的 Nest 建立 Thread Group，推出了物联网通信协议Thread，就是基于 UDP 协议的。
* **移动通信**：在 4G 网络里，移动流量上网的数据面对的协议 GTP-U 是基于 UDP 的。

## TCP

**传输控制协议**（**T**ransmission **C**ontrol **P**rotocol，**TCP**）是一种面向连接的、可靠的、基于字节流的传输层通信协议。

### TCP 头

![](../../.gitbook/assets/image%20%2849%29.png)

### 三次握手

### 四次挥手

### 状态机

## 对比

* UDP 是面向无连接的；TCP 是面向连接的。
* TCP 提供可靠传输（无差错、不丢失、不重复、按序到达）；UDP 是不可靠的，可能丢失，顺序可能不一致。
* TCP 是面向字节流的，通过 TCP 自己的状态实现；UDP 是基于数据报的。
* TCP 可以控制拥塞；UDP 不能。

{% hint style="info" %}
面向连接：在互通之前，会先建立连接，比如 TCP 的三次握手。建立连接，是为了在客户端和服务端维护连接，而建立一定的**数据结构**来维护双方交互的**状态**。
{% endhint %}

