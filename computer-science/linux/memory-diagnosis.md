# Memory Diagnosis

## 原理

Linux 给每个进程都提供了一个独立的虚拟地址空间，连续的。虚拟地址空间又分为内核空间（高位）和用户空间（低位）。进程在用户态时，只能访问用户空间内存；进入内核态后才能访问内核空间内存。**每个进程的内核空间关联的是相同的物理内存**。

![](../../.gitbook/assets/image%20%28290%29.png)

并不是所有的虚拟内存都会分配物理内存，内核为每个进程都维护了一张页表，记录虚拟地址与物理地址的映射关系。页表存储在 MMU 中。虚拟地址在页表中查不到时，系统产生一个**缺页异常**，进入内核空间分配物理内存、更新进程页表，最后再返回用户空间，恢复进程的运行。

![](../../.gitbook/assets/image%20%28292%29.png)

TLB 是 MMU 的高速缓存，若上下文切换过多，则 TLB 的刷新次数增加，进程的 MMU 是独立的，所以会导致 TLB 缓存的使用率降低。

MMU 规定了内存映射的最小单位，一般为 4KB。页仅为 4KB，页表就会很大，Linux 提供了**多级页表**和**大页**两种方式来解决此问题。Linux 用四级页表来管理内存，前四个表用于选择页，最后一个索引表示页内偏移。

![](../../.gitbook/assets/image%20%28293%29.png)

虚拟内存空间的用户空间又被分为多个不同的段。以 32位系统为例：

* 只读段，代码和常量
* 数据段，全局变量
* 堆，动态分配的内存，malloc\(\) 分配
* 文件映射段，动态库，共享内存 mmap\(\) 分配
* 栈，局部变量，函数调用的上下文。大小固定，一般 8MB

![](../../.gitbook/assets/image%20%28291%29.png)

malloc

