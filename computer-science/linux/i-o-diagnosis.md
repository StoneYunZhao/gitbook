# I/O Diagnosis

## 文件系统

### 索引节点和目录项

文件系统在磁盘的基础上，提供了一个用来管理文件的树状结构。Linux 为每个文件都分配两个数据结构，索引节点（index node）和目录项（directory entry）：

* 索引节点，inode：记录文件的元数据，如 inode 编号、文件大小、访问权限、修改日期、数据位置等。inode 和文件一一对应，会被持久化到磁盘。在磁盘格式化的时候设定好的。
* 目录项，dentry：记录文件的名字、inode 指针、与其它 dentry 的关联关系。由内核维护的**内存**数据结构，也叫目录项缓存。

dentry 与 inode 是多对一的关系，即一个文件可以有多个别名。通过硬链接为文件创建别名，就会有不同的目录项，这些目录项的索引节点相同。

磁盘读写的最小单位是扇区（512B），文件系统把连续的扇区组成逻辑块，以逻辑块为最小单元来管理数据。常见的逻辑块为 4KB，即 8 个连续扇区。

![](../../.gitbook/assets/image%20%28301%29.png)

内存一节提到文件内容会缓存到页缓存 Cache 中，索引节点也会缓存到内存中。另外，磁盘在执行文件系统格式化时，会分成三个存储区，超级块会存储整个文件系统的状态。

内核使用 slab 机制管理目录项和索引节点。

可通过 df 查看磁盘容量。free, vmstat, /proc/meminfo, /proc/slabinfo, slabtop 等工具查看文件的缓存信息。

### VFS

为了支持各种不同的文件系统，Linux 内核在用户进程和文件系统中，引入一个 VFS（Virtual File System） 抽象层。VFS 定义了一组标准的数据结构和接口，所以用户进程使用时不需要关心底层文件系统的实现细节。

![](../../.gitbook/assets/image%20%28296%29.png)

Linux 支持多种文件系统，这些文件系统首先得挂载到 VFS 目录树中的某个子目录（挂载点），然后才能访问。支持的文件系统主要分为：

* 基于磁盘：Ext4、XFS、OverlayFS 等。
* 基于内存：/proc、/sys 等。
* 网络：NFS、SMB、iSCSI 等。

### I/O 分类

是否利用标准库缓存：

* 缓冲 IO：使用标准库缓存来加速文件访问，标准库内部再通过系统调用访问文件。
* 非缓冲 IO：直接通过系统调用。

是否利用操作系统的页缓存：

* 直接 IO：跳过操作系统的页缓存，直接与文件系统交互。需要指定 O\_DIRECT。
* 非直接 IO：文件读写时，先经过页缓存。默认选项。

{% hint style="info" %}
直接 IO 与非直接 IO 都是与文件系统交互。跳过文件系统直接读写磁盘叫做裸 IO。
{% endhint %}

应用程序是否阻塞自身运行：

* 阻塞 IO：应用程序执行 IO 操作后，在获取响应之前会阻塞当前线程。
* 非阻塞 IO：执行 IO 后，不阻塞，可以执行其它任务。随后通过轮询或事件通知的方式获取调用结果。

是否等待响应结果：

* 同步 IO：等 IO 完成后才能获取 IO 响应。
* 异步 IO：IO 操作后，不用等待 IO 完成，可以继续执行其它逻辑。

O\_SYNC，O\_DSYNC 代表同步，O\_SYNC 是在 O\_DSYNC 基础上，文件元数据写入磁盘后才能返回。

## 磁盘





